/*增量式PID结构体*/
//定义一个名为PID_M 的结构体
#include "common.h"
#include "include.h"
#include "Distance_PID.h"
struct
{
  int16 Current_Error;  //当前差值   E(0)
  int16 Last_Error;     //上次差值   E(-1)
  int16 Prev_Error;     //上上次差值 E(-2)
}D_PID; 

//定义Kp、Ki、Kd 三个参数
float   
        D_Proportion =5,
        D_Integral =0,
        D_Derivative =0; 
//PID 的增量输出
uint16 PID_d_add ; 
extern uint16 Distance_Set_Goal;
extern float OutData[4];
extern uint16 distance;
void Distance_Control(uint16 distance)
{
   /*定义局部变量*/
   int16 P,I,D;
   /*更新每次的差值*/
   D_PID.Prev_Error=D_PID.Last_Error;
   /*更新每次的差值*/
   D_PID.Last_Error=D_PID.Current_Error;
    /*更新每次的差值*/
   D_PID.Current_Error=Distance_Set_Goal-distance; 
   
   P=D_Proportion*(D_PID.Current_Error-D_PID.Last_Error); //比例P 输出公式                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
   I=D_Integral* D_PID.Current_Error;                     //积分I 输出公式
   D=D_Derivative*(D_PID.Current_Error+D_PID.Prev_Error-2*D_PID.Last_Error); //微分D 输出公式
   
   PID_d_add+=P+I+D;
   OutData[1]=PID_d_add;
   if(PID_d_add-300>0) PID_d_add=300;
   if(PID_d_add+300<0) PID_d_add=-300;    
   FTM_CnV_REG(FTMN[0], FTM_CH0)-=PID_d_add;
   OutData[3]=FTM_CnV_REG(FTMN[0], FTM_CH0);
}